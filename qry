SELECT
  site."Site code" as site_code,
  site.geom,
  sd."Date" as sample_date,
  sd.currency_date as landuse_layer_date,
  COALESCE( lhd.HISTO_NODATA_P, lhd.HISTO_15_P ) as HISTO_UNKNOWN,
  lhd.HISTO_1_P,
  lhd.HISTO_2_P,
  lhd.HISTO_4_P,
  lhd.HISTO_5_P,
  lhd.HISTO_6_P,
  lhd.HISTO_7_P,
  lhd.HISTO_8_P,
  lhd.HISTO_9_P,
  lhd.HISTO_10_P,
  lhd.HISTO_11_P,
  lhd.HISTO_12_P,
  lhd.HISTO_13_P,
  lhd.HISTO_14_P
FROM 
(SELECT sig."Site code", sig."Date", COALESCE((SELECT MAX(currency_date) FROM landuse_layer_date WHERE currency_date <= sig."Date"),(SELECT MIN(currency_date) FROM landuse_layer_date)) as currency_date 
FROM site_signal_score sig) as sd
JOIN site ON site."Site code" = sd."Site code"
JOIN landuse_histogram_date lhd ON lhd."Site code" = sd."Site code" AND lhd.currency_date = sd.currency_date
 